<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SIN FARM</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
html,body{width:100%;height:100%;background:#0a0805;overflow:hidden;touch-action:none;}

/* â”€â”€ Shell: scales to fit screen â”€â”€ */
#shell{
  position:absolute;
  transform-origin:top left;
  display:flex;flex-direction:column;
  background:#1a1208;
  border-radius:0;
}

/* â”€â”€ Seed bar (top) â”€â”€ */
#seed-bar{
  flex:0 0 52px;
  background:#100c06;
  border-bottom:2px solid #2a1e0c;
  display:flex;align-items:center;
  padding:0 8px;gap:5px;
}
#seed-bar-label{
  color:#6a5030;font-family:'Courier New',monospace;font-size:9px;
  letter-spacing:1px;white-space:nowrap;margin-right:4px;
}
.seed-btn{
  flex:1;max-width:58px;height:38px;border-radius:6px;
  background:#0c0906;border:1.5px solid #2a1a08;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-size:14px;line-height:1;cursor:pointer;touch-action:none;
  transition:border-color 0.1s,background 0.1s;
}
.seed-btn span{font-size:8px;color:#5a4a2a;margin-top:1px;font-family:'Courier New',monospace;}
.seed-btn.locked{opacity:0.25;}
.seed-btn.active{border-color:#c8a020;background:#1e1508;box-shadow:0 0 6px rgba(200,160,30,0.35);}
#coins-hud{
  margin-left:auto;
  color:#c8a020;font-family:'Courier New',monospace;font-size:11px;
  font-weight:bold;white-space:nowrap;padding-left:6px;
}

/* â”€â”€ Canvas area â”€â”€ */
#canvas-wrap{
  flex:0 0 auto;position:relative;
  overflow:hidden;
}
canvas{display:block;image-rendering:pixelated;}

/* â”€â”€ Control panel (bottom, gameboy style) â”€â”€ */
#controls{
  flex:1;
  background:#0e0b07;
  border-top:2px solid #2a1e0c;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;
  min-height:130px;
}

/* D-Pad */
#dpad{position:relative;width:110px;height:110px;flex-shrink:0;}
.dpad-btn{
  position:absolute;
  background:#181208;border:1.5px solid #3a2810;border-radius:4px;
  display:flex;align-items:center;justify-content:center;
  color:#5a4020;font-size:14px;cursor:pointer;touch-action:none;
  transition:background 0.08s;
}
.dpad-btn:active,.dpad-btn.pressed{background:#2a1e0c;color:#c8a020;}
#dp-up{top:0;left:50%;transform:translateX(-50%);width:34px;height:34px;}
#dp-dn{bottom:0;left:50%;transform:translateX(-50%);width:34px;height:34px;}
#dp-lt{top:50%;left:0;transform:translateY(-50%);width:34px;height:34px;}
#dp-rt{top:50%;right:0;transform:translateY(-50%);width:34px;height:34px;}
#dp-c{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:30px;height:30px;border-radius:50%;
  background:#120f08;border:1px solid #2a1e0c;
}

/* Center buttons */
#center-btns{
  display:flex;flex-direction:column;align-items:center;gap:8px;
}
.mini-btn{
  padding:5px 14px;border-radius:20px;
  background:#130f08;border:1.5px solid #3a2810;
  color:#5a4020;font-family:'Courier New',monospace;font-size:9px;
  cursor:pointer;touch-action:none;letter-spacing:1px;
  transition:background 0.08s,color 0.08s;
}
.mini-btn:active,.mini-btn.pressed{background:#2a1e0c;color:#c8a020;}
#btn-shop-wrap{display:flex;gap:6px;}

/* Action buttons */
#action-btns{
  display:flex;flex-direction:column;align-items:center;gap:10px;flex-shrink:0;
}
#action-row{display:flex;gap:14px;align-items:center;}
.act-btn{
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  cursor:pointer;touch-action:none;font-size:13px;font-weight:bold;
  font-family:'Courier New',monospace;
  transition:filter 0.08s,transform 0.08s;
  border:2px solid;
}
.act-btn:active,.act-btn.pressed{filter:brightness(1.4);transform:scale(0.93);}
#btn-atk{
  width:60px;height:60px;
  background:radial-gradient(circle at 35% 35%,#8a1010,#3a0505);
  border-color:#d03020;color:#ff8060;
  box-shadow:0 0 12px rgba(200,40,20,0.45);
}
#btn-e{
  width:48px;height:48px;
  background:radial-gradient(circle at 35% 35%,#105a10,#041404);
  border-color:#30c030;color:#60e060;
  box-shadow:0 0 10px rgba(40,180,40,0.35);
}
#btn-labels{display:flex;gap:14px;margin-top:2px;}
.btn-label{font-family:'Courier New',monospace;font-size:8px;color:#3a2a18;text-align:center;}
#btn-label-atk{width:60px;}
#btn-label-e{width:48px;}
</style>
</head>
<body>
<div id="shell">
  <!-- Top: Seed bar -->
  <div id="seed-bar">
    <div id="seed-bar-label">Ğ¡Ğ•ĞœĞ•ĞĞâ–¸</div>
    <!-- seeds injected by JS -->
    <div id="coins-hud">ğŸ’° 0</div>
  </div>

  <!-- Middle: Game canvas -->
  <div id="canvas-wrap">
    <canvas id="c"></canvas>
  </div>

  <!-- Bottom: Gameboy controls -->
  <div id="controls">
    <!-- D-Pad -->
    <div id="dpad">
      <div class="dpad-btn" id="dp-up">â–²</div>
      <div class="dpad-btn" id="dp-lt">â—€</div>
      <div id="dp-c"></div>
      <div class="dpad-btn" id="dp-rt">â–¶</div>
      <div class="dpad-btn" id="dp-dn">â–¼</div>
    </div>

    <!-- Center: shop / select -->
    <div id="center-btns">
      <div id="btn-shop-wrap">
        <div class="mini-btn" id="btn-shop">Ğ›ĞĞ’ĞšĞ</div>
        <div class="mini-btn" id="btn-shop-close" style="display:none">Ğ—ĞĞšĞ Ğ«Ğ¢Ğ¬</div>
      </div>
      <div class="mini-btn" id="btn-buy" style="display:none">â—† ĞšĞ£ĞŸĞ˜Ğ¢Ğ¬</div>
      <div class="mini-btn" id="btn-sell" style="display:none">â—‡ Ğ¡Ğ”ĞĞ¢Ğ¬</div>
    </div>

    <!-- Action buttons -->
    <div id="action-btns">
      <div id="action-row">
        <div>
          <div class="act-btn" id="btn-e">E</div>
        </div>
        <div>
          <div class="act-btn" id="btn-atk">ğŸª“</div>
        </div>
      </div>
      <div id="btn-labels">
        <div class="btn-label" id="btn-label-e">Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ</div>
        <div class="btn-label" id="btn-label-atk">ÑƒĞ´Ğ°Ñ€</div>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';
// â”€â”€ Canvas & game dimensions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GW=768,GH=440,TS=40;  // shorter canvas, smaller tiles
const C=document.getElementById('c');
const ctx=C.getContext('2d');
C.width=GW;C.height=GH;

const SEED_BAR_H=52;
const CTRL_H=134;
const SHELL_H=GH+SEED_BAR_H+CTRL_H;
const SHELL_W=GW;

const shell=document.getElementById('shell');
shell.style.width=SHELL_W+'px';
shell.style.height=SHELL_H+'px';
document.getElementById('canvas-wrap').style.height=GH+'px';

function resize(){
  const sc=Math.min(window.innerWidth/SHELL_W, window.innerHeight/SHELL_H);
  const ox=(window.innerWidth-SHELL_W*sc)/2;
  const oy=(window.innerHeight-SHELL_H*sc)/2;
  shell.style.transform=`scale(${sc})`;
  shell.style.left=ox+'px';
  shell.style.top=oy+'px';
}
resize();
window.addEventListener('resize',resize);

// â”€â”€ Sins data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SINS=[
  {id:0,name:'Ğ›Ğ•ĞĞ¬',       en:'SLOTH',   color:'#a08870',dark:'#4a3428',glow:'#c0a080',seedCost:15,  sellPrice:40,  growTime:16, sym:'ğŸ’¤'},
  {id:1,name:'Ğ§Ğ Ğ•Ğ’ĞĞ£Ğ“.',  en:'GLUTTONY',color:'#c06030',dark:'#603018',glow:'#e08040',seedCost:40,  sellPrice:105, growTime:28, sym:'ğŸ—'},
  {id:2,name:'Ğ–ĞĞ”ĞĞĞ¡Ğ¢Ğ¬',  en:'GREED',   color:'#d0a020',dark:'#705010',glow:'#f0c040',seedCost:90,  sellPrice:240, growTime:42, sym:'ğŸ’°'},
  {id:3,name:'ĞŸĞĞ¥ĞĞ¢Ğ¬',    en:'LUST',    color:'#c02840',dark:'#601020',glow:'#f04060',seedCost:220, sellPrice:580, growTime:60, sym:'ğŸŒ¹'},
  {id:4,name:'Ğ—ĞĞ’Ğ˜Ğ¡Ğ¢Ğ¬',   en:'ENVY',    color:'#408030',dark:'#204018',glow:'#60c048',seedCost:540, sellPrice:1400,growTime:85, sym:'ğŸ'},
  {id:5,name:'Ğ“ĞĞ•Ğ’',      en:'WRATH',   color:'#e03010',dark:'#701808',glow:'#ff5020',seedCost:1300,sellPrice:3300,growTime:115,sym:'ğŸ”¥'},
  {id:6,name:'Ğ“ĞĞ Ğ”Ğ«ĞĞ¯',   en:'PRIDE',   color:'#8020c0',dark:'#401060',glow:'#b040f0',seedCost:3000,sellPrice:7500,growTime:155,sym:'ğŸ‘‘'},
];

// â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 0=path 1=soil 2=shop 3=wall  â€” 19Ã—11 tiles
const COLS=19,ROWS=11;
const MAP=[
  [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
  [3,2,2,2,3,1,1,1,1,0,1,1,1,1,0,1,1,1,3],
  [3,2,2,2,3,1,1,1,1,0,1,1,1,1,0,1,1,1,3],
  [3,2,2,2,3,1,1,1,1,0,1,1,1,1,0,1,1,1,3],
  [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
  [3,0,0,0,0,1,1,1,1,0,1,1,1,1,0,1,1,1,3],
  [3,0,0,0,0,1,1,1,1,0,1,1,1,1,0,1,1,1,3],
  [3,0,0,0,0,1,1,1,1,0,1,1,1,1,0,1,1,1,3],
  [3,0,0,0,0,1,1,1,1,0,1,1,1,1,0,1,1,1,3],
  [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
  [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
];
// Validate map width
for(let r=0;r<ROWS;r++) while(MAP[r].length<COLS) MAP[r].push(3);

const PLOT_COORDS=[];
for(let r=1;r<=3;r++){for(let c=5;c<=8;c++)PLOT_COORDS.push([c,r]);for(let c=10;c<=13;c++)PLOT_COORDS.push([c,r]);for(let c=15;c<=17;c++)PLOT_COORDS.push([c,r]);}
for(let r=5;r<=8;r++){for(let c=5;c<=8;c++)PLOT_COORDS.push([c,r]);for(let c=10;c<=13;c++)PLOT_COORDS.push([c,r]);for(let c=15;c<=17;c++)PLOT_COORDS.push([c,r]);}

const ETYPES=[
  {name:'Ğ“Ğ¾Ğ»ÑƒĞ±ÑŒ',  maxHp:1,speed:0.7, reward:8, color:'#d8d8cc',size:11,cropDmg:8, pdmg:1,ulk:0},
  {name:'Ğ¯Ğ³Ğ½Ñ‘Ğ½Ğ¾Ğº', maxHp:2,speed:0.9, reward:18,color:'#e0cc80',size:14,cropDmg:14,pdmg:1,ulk:1},
  {name:'Ğ¡Ñ‚Ñ€Ğ°Ğ¶',  maxHp:4,speed:1.1, reward:35,color:'#b8ccde',size:17,cropDmg:20,pdmg:2,ulk:3},
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const gs={
  coins:50,seeds:new Array(7).fill(0),discovered:new Array(7).fill(false),
  plots:PLOT_COORDS.map(([x,y])=>({x,y,sinId:-1,plantedAt:0,stage:0,health:100})),
  player:{x:2.5*TS,y:6.5*TS,hp:10,maxHp:10,facing:0,atkTimer:0,atkOn:false,invTimer:0,regenT:0,dead:false,sel:0},
  enemies:[],
  rain:Array.from({length:160},()=>({x:Math.random()*GW,y:Math.random()*GH,s:1.2+Math.random()*2.5,l:7+Math.random()*18,o:0.04+Math.random()*0.10})),
  shop:{open:false,sel:0},notify:null,spawnT:0,t:0,win:false,
};

// â”€â”€ Virtual keys from d-pad â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const vkeys={up:false,dn:false,lt:false,rt:false};
function dpadBind(id,key){
  const el=document.getElementById(id);
  const on=()=>{vkeys[key]=true;el.classList.add('pressed');};
  const off=()=>{vkeys[key]=false;el.classList.remove('pressed');};
  el.addEventListener('touchstart',e=>{e.preventDefault();on();},{passive:false});
  el.addEventListener('touchend',e=>{e.preventDefault();off();},{passive:false});
  el.addEventListener('touchcancel',off);
  el.addEventListener('mousedown',on);
  el.addEventListener('mouseup',off);
  el.addEventListener('mouseleave',off);
}
dpadBind('dp-up','up');dpadBind('dp-dn','dn');dpadBind('dp-lt','lt');dpadBind('dp-rt','rt');

// â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const keys={};
document.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='Tab'){e.preventDefault();toggleShop();}
  if(e.code==='Space'){e.preventDefault();attack();}
  if(e.code==='KeyE')interact();
  if(gs.shop.open){
    if(e.code==='ArrowUp'||e.code==='KeyW')shopNav(-1);
    if(e.code==='ArrowDown'||e.code==='KeyS')shopNav(1);
    if(e.code==='KeyB')buyItem();if(e.code==='KeyV')sellItem();
  }
  for(let i=1;i<=7;i++)if(e.code==='Digit'+i)selectSeed(i-1);
});
document.addEventListener('keyup',e=>keys[e.code]=false);

// â”€â”€ Button bindings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tbind(id,fn){
  const el=document.getElementById(id);
  if(!el)return;
  el.addEventListener('touchstart',e=>{e.preventDefault();fn();el.classList.add('pressed');setTimeout(()=>el.classList.remove('pressed'),200);},{passive:false});
  el.addEventListener('mousedown',()=>{fn();});
}
tbind('btn-atk',attack);
tbind('btn-e',interact);
tbind('btn-shop',toggleShop);
tbind('btn-shop-close',toggleShop);
tbind('btn-buy',buyItem);
tbind('btn-sell',sellItem);

// â”€â”€ Seed bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const seedBar=document.getElementById('seed-bar');
function buildSeedBar(){
  // Remove old seed buttons (keep label and coins)
  seedBar.querySelectorAll('.seed-btn').forEach(e=>e.remove());
  const coinsEl=document.getElementById('coins-hud');
  for(let i=6;i>=0;i--){
    const b=document.createElement('div');
    b.className='seed-btn'+(i===gs.player.sel?' active':'')+(unlocked(i)?'':' locked');
    b.innerHTML=SINS[i].sym+'<span>Ã—'+gs.seeds[i]+'</span>';
    b.dataset.i=i;
    b.addEventListener('touchstart',e=>{e.preventDefault();selectSeed(i);},{passive:false});
    b.addEventListener('mousedown',()=>selectSeed(i));
    // Insert before coins
    seedBar.insertBefore(b,coinsEl);
  }
  updateCoinsHUD();
}
function updateSeedBar(){
  seedBar.querySelectorAll('.seed-btn').forEach((b)=>{
    const i=parseInt(b.dataset.i);
    b.className='seed-btn'+(i===gs.player.sel?' active':'')+(unlocked(i)?'':' locked');
    b.innerHTML=SINS[i].sym+'<span>Ã—'+gs.seeds[i]+'</span>';
  });
  updateCoinsHUD();
}
function updateCoinsHUD(){document.getElementById('coins-hud').textContent='ğŸ’° '+gs.coins;}
buildSeedBar();

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function unlocked(id){return id===0||gs.discovered[id-1];}
function discoveredCount(){return gs.discovered.filter(Boolean).length;}
function selectSeed(i){gs.player.sel=i;updateSeedBar();}
function notify(sinId){gs.notify={sinId,start:Date.now()};setTimeout(()=>{if(gs.notify?.sinId===sinId)gs.notify=null;},4000);}
function shopNav(d){gs.shop.sel=Math.max(0,Math.min(6,gs.shop.sel+d));}
function toggleShop(){
  if(!gs.player.dead&&!gs.win){
    gs.shop.open=!gs.shop.open;
    document.getElementById('btn-shop').style.display=gs.shop.open?'none':'block';
    document.getElementById('btn-shop-close').style.display=gs.shop.open?'block':'none';
    document.getElementById('btn-buy').style.display=gs.shop.open?'block':'none';
    document.getElementById('btn-sell').style.display=gs.shop.open?'block':'none';
  }
}

// â”€â”€ Game logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function attack(){
  const p=gs.player;if(gs.shop.open||p.dead)return;
  const now=Date.now();if(now-p.atkTimer<450)return;
  p.atkTimer=now;p.atkOn=true;setTimeout(()=>p.atkOn=false,220);
  const dirs=[[1,0],[0,1],[-1,0],[0,-1]];const[ddx,ddy]=dirs[p.facing];
  const ax=p.x+ddx*28,ay=p.y+ddy*28;
  gs.enemies=gs.enemies.filter(e=>{
    if(Math.hypot(e.x-ax,e.y-ay)<48){e.hp-=2;e.hit=Date.now();if(e.hp<=0){gs.coins+=e.reward;updateCoinsHUD();return false;}}
    return true;
  });
}
function interact(){
  if(gs.shop.open||gs.player.dead)return;
  const p=gs.player,px=Math.floor(p.x/TS),py=Math.floor(p.y/TS);
  for(const pl of gs.plots){
    if(Math.abs(pl.x-px)<=1&&Math.abs(pl.y-py)<=1){
      if(pl.stage===3){
        const s=SINS[pl.sinId];
        gs.coins+=Math.floor(s.sellPrice*(pl.health/100));
        if(!gs.discovered[pl.sinId]){gs.discovered[pl.sinId]=true;notify(pl.sinId);buildSeedBar();}
        if(gs.discovered.every(Boolean))setTimeout(()=>gs.win=true,2500);
        pl.stage=0;pl.sinId=-1;pl.health=100;updateCoinsHUD();return;
      }
      if(pl.stage===0){
        const sid=p.sel;
        if(unlocked(sid)&&gs.seeds[sid]>0){pl.sinId=sid;pl.stage=1;pl.plantedAt=Date.now();pl.health=100;gs.seeds[sid]--;updateSeedBar();return;}
        for(let i=0;i<7;i++){if(unlocked(i)&&gs.seeds[i]>0){pl.sinId=i;pl.stage=1;pl.plantedAt=Date.now();pl.health=100;gs.seeds[i]--;updateSeedBar();return;}}
      }
      return;
    }
  }
}
function buyItem(){
  const id=gs.shop.sel;if(!unlocked(id))return;
  if(gs.coins>=SINS[id].seedCost){gs.coins-=SINS[id].seedCost;gs.seeds[id]++;updateSeedBar();}
}
function sellItem(){
  const id=gs.shop.sel;
  if(gs.seeds[id]>0){gs.seeds[id]--;gs.coins+=Math.floor(SINS[id].seedCost*0.5);updateSeedBar();}
}
function isWall(px,py){
  const m=9;
  for(const[x,y]of[[px-m,py-m],[px+m,py-m],[px-m,py+m],[px+m,py+m]]){
    const tc=Math.floor(x/TS),tr=Math.floor(y/TS);
    if(tr<0||tr>=ROWS||tc<0||tc>=COLS)return true;
    const t=MAP[tr][tc];if(t===3||t===2)return true;
  }
  return false;
}

// â”€â”€ Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePlayer(dt){
  const p=gs.player;if(p.dead||gs.shop.open)return;
  const sp=2.4;let dx=0,dy=0;
  const goL=keys['KeyA']||keys['ArrowLeft']||vkeys.lt;
  const goR=keys['KeyD']||keys['ArrowRight']||vkeys.rt;
  const goU=keys['KeyW']||keys['ArrowUp']||vkeys.up;
  const goD=keys['KeyS']||keys['ArrowDown']||vkeys.dn;
  if(goL){dx-=sp;p.facing=2;}if(goR){dx+=sp;p.facing=0;}
  if(goU){dy-=sp;p.facing=3;}if(goD){dy+=sp;p.facing=1;}
  if(dx&&dy){dx*=0.707;dy*=0.707;}
  if(!isWall(p.x+dx,p.y))p.x+=dx;
  if(!isWall(p.x,p.y+dy))p.y+=dy;
  p.x=Math.max(TS+10,Math.min(GW-TS-10,p.x));
  p.y=Math.max(TS+10,Math.min(GH-TS-10,p.y));
  if(p.invTimer>0)p.invTimer-=dt;
  p.regenT+=dt;if(p.regenT>5000){p.regenT=0;p.hp=Math.min(p.maxHp,p.hp+1);}
}
function updatePlots(){
  const now=Date.now();
  for(const p of gs.plots){
    if(p.stage<1||p.stage>=3)continue;
    const el=(now-p.plantedAt)/1000,gt=SINS[p.sinId].growTime;
    if(el>=gt)p.stage=3;else if(el>=gt*0.5)p.stage=2;else p.stage=1;
  }
}
function updateEnemies(){
  const now=Date.now(),p=gs.player;
  for(const e of gs.enemies){
    let tgt=null,td=9999;
    for(const pl of gs.plots){if(pl.stage<1)continue;const d=Math.hypot(pl.x*TS+TS/2-e.x,pl.y*TS+TS/2-e.y);if(d<td){td=d;tgt=pl;}}
    if(tgt&&td<300){const tx=tgt.x*TS+TS/2,ty=tgt.y*TS+TS/2,d=Math.hypot(tx-e.x,ty-e.y);if(d>20){e.x+=(tx-e.x)/d*e.speed;e.y+=(ty-e.y)/d*e.speed;}else if(now-e.atkT>1100){e.atkT=now;tgt.health-=e.cropDmg;if(tgt.health<=0){tgt.stage=0;tgt.sinId=-1;tgt.health=100;}}}
    else{if(now-e.wT>2500){e.wT=now;const pts=[[1,4],[7,4],[14,4],[1,9],[7,9],[14,9]];const pt=pts[Math.random()*pts.length|0];e.wx=pt[0]*TS+(Math.random()-.5)*30;e.wy=pt[1]*TS+(Math.random()-.5)*30;}const d=Math.hypot(e.wx-e.x,e.wy-e.y);if(d>6){e.x+=(e.wx-e.x)/d*e.speed*0.5;e.y+=(e.wy-e.y)/d*e.speed*0.5;}}
    if(p.invTimer<=0&&Math.hypot(p.x-e.x,p.y-e.y)<20){p.hp-=e.pdmg;p.invTimer=1200;if(p.hp<=0){p.hp=0;p.dead=true;}}
  }
}
function updateSpawn(dt){
  gs.spawnT+=dt;const dc=discoveredCount(),iv=Math.max(7000,22000-dc*2000),mx=4+dc;
  if(gs.spawnT>iv&&gs.enemies.length<mx){
    gs.spawnT=0;
    const av=ETYPES.filter(t=>dc>=t.ulk);const tp=av[Math.random()*av.length|0];
    const pts=[[1,4],[18,4],[1,9],[18,9]];const sp=pts[Math.random()*pts.length|0];
    gs.enemies.push({x:sp[0]*TS,y:sp[1]*TS,hp:tp.maxHp,maxHp:tp.maxHp,speed:tp.speed,reward:tp.reward,color:tp.color,size:tp.size,cropDmg:tp.cropDmg,pdmg:tp.pdmg,name:tp.name,atkT:0,wT:0,wx:sp[0]*TS,wy:sp[1]*TS,hit:0});
  }
}

// â”€â”€ Drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Lighter palette for tiles
function drawTile(c,r){
  const x=c*TS,y=r*TS,t=MAP[r][c];
  if(t===3){
    // Wall - lighter stone
    ctx.fillStyle='#1e1a12';ctx.fillRect(x,y,TS,TS);
    ctx.fillStyle='#252018';ctx.fillRect(x+1,y+1,TS-2,TS-2);
    // mortar lines
    ctx.fillStyle='#1a1610';
    if(r%2===0){ctx.fillRect(x,y+TS/2-1,TS,2);}else{ctx.fillRect(x+TS/2-1,y,2,TS);}
  } else if(t===0){
    // Path - lighter cobblestone
    ctx.fillStyle='#201c14';ctx.fillRect(x,y,TS,TS);
    ctx.fillStyle='#282418';ctx.fillRect(x+2,y+2,TS-4,TS-4);
    ctx.fillStyle='#1e1a12';
    for(let i=0;i<5;i++)ctx.fillRect(x+(c*7+i*11)%TS,y+(r*9+i*13)%TS,1,1);
  } else if(t===1){
    // Soil - warm brown
    ctx.fillStyle='#2a2010';ctx.fillRect(x,y,TS,TS);
    ctx.fillStyle='#342818';ctx.fillRect(x+2,y+2,TS-4,TS-4);
    ctx.fillStyle='#2e2214';ctx.fillRect(x+5,y+5,TS-10,TS-10);
    // little texture dots
    ctx.fillStyle='#382c1a';
    for(let i=0;i<3;i++)ctx.fillRect(x+(c*11+i*13)%TS,y+(r*7+i*17)%TS,2,2);
  } else if(t===2){
    ctx.fillStyle='#220c0c';ctx.fillRect(x,y,TS,TS);
  }
}

function drawMap(){
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)drawTile(c,r);
  // Shop building
  ctx.fillStyle='#2e1010';ctx.fillRect(TS,TS,3*TS,3*TS);
  ctx.strokeStyle='#8a1a1a';ctx.lineWidth=2;ctx.strokeRect(TS+1,TS+1,3*TS-2,3*TS-2);
  ctx.strokeStyle='#5a1010';ctx.lineWidth=1;ctx.strokeRect(TS+4,TS+4,3*TS-8,3*TS-8);
  // Sign
  ctx.fillStyle='#8a1a1a';ctx.fillRect(TS+8,TS+7,3*TS-16,22);
  ctx.strokeStyle='#d4a828';ctx.lineWidth=1;ctx.strokeRect(TS+8,TS+7,3*TS-16,22);
  ctx.fillStyle='#d4a828';ctx.font='bold 8px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('âšœ Ğ›ĞĞ’ĞšĞ Ğ“Ğ Ğ•Ğ¥ĞĞ’ âšœ',TS+1.5*TS,TS+18);
  // Windows
  for(const wx of[TS+9,TS+3*TS-24]){
    ctx.fillStyle='#180808';ctx.fillRect(wx,TS+34,14,14);
    ctx.strokeStyle='#501010';ctx.lineWidth=1;ctx.strokeRect(wx,TS+34,14,14);
    ctx.fillStyle='rgba(80,20,20,0.5)';ctx.fillRect(wx+2,TS+36,10,10);
  }
  // Door
  ctx.fillStyle='#380e0e';ctx.fillRect(TS+TS+11,3*TS+4,20,26);
  ctx.strokeStyle='#6a1818';ctx.lineWidth=1;ctx.strokeRect(TS+TS+11,3*TS+4,20,26);
  ctx.fillStyle='#d4a828';ctx.beginPath();ctx.arc(TS+TS+27,3*TS+18,2,0,Math.PI*2);ctx.fill();
  // TAB label
  ctx.fillStyle='#6a3030';ctx.font='8px Courier New';ctx.textAlign='center';ctx.textBaseline='alphabetic';
  ctx.fillText('[TAB]',TS+1.5*TS,4*TS+14);
  // Soil grid
  ctx.strokeStyle='rgba(80,50,15,0.2)';ctx.lineWidth=0.5;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if(MAP[r][c]===1)ctx.strokeRect(c*TS,r*TS,TS,TS);
}

function drawPlots(){
  const hs=TS/2;
  for(const pl of gs.plots){
    if(pl.stage===0)continue;
    const s=SINS[pl.sinId],px=pl.x*TS,py=pl.y*TS,cx=px+hs,cy=py+hs,hp=pl.health/100;
    if(hp<1){ctx.fillStyle=`rgba(200,0,0,${(1-hp)*0.35})`;ctx.fillRect(px,py,TS,TS);}
    if(pl.stage===1){
      // Seedling
      ctx.fillStyle=s.dark;ctx.beginPath();ctx.ellipse(cx,cy+3,10,5,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=s.color;ctx.beginPath();ctx.arc(cx,cy-2,5,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=s.dark;ctx.fillRect(cx-1,cy+1,2,5);
    } else if(pl.stage===2){
      // Growing
      ctx.fillStyle=s.dark;ctx.fillRect(cx-10,cy-6,20,18);
      ctx.fillStyle=s.color;ctx.fillRect(cx-7,cy-14,14,16);
      ctx.fillStyle=s.glow;ctx.fillRect(cx-3,cy-14,6,6);
    } else {
      // Ready - glowing
      const pulse=0.6+0.4*Math.sin(gs.t/260);
      ctx.shadowColor=s.glow;ctx.shadowBlur=20*pulse;
      ctx.fillStyle=s.color;ctx.beginPath();ctx.arc(cx,cy,14,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=5;ctx.fillStyle=s.glow;ctx.beginPath();ctx.arc(cx,cy-2,7,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;
      ctx.font='12px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(s.sym,cx,cy);ctx.textBaseline='alphabetic';
      ctx.fillStyle='#d4a828';ctx.font='bold 7px Courier New';ctx.fillText('[E]',cx,py+7);
    }
    // Crop label
    ctx.fillStyle='rgba(150,110,60,0.75)';ctx.font='7px Courier New';ctx.textAlign='center';ctx.textBaseline='alphabetic';
    ctx.fillText(s.en.slice(0,5),cx,py+TS-3);
    // HP bar
    if(hp<1){ctx.fillStyle='#400';ctx.fillRect(px+3,py+TS-8,TS-6,3);ctx.fillStyle='#e02020';ctx.fillRect(px+3,py+TS-8,(TS-6)*hp,3);}
  }
}

function drawPlayer(){
  const p=gs.player;if(p.dead)return;
  if(p.invTimer>0&&Math.floor(Date.now()/80)%2)return;
  const x=p.x,y=p.y;
  const moving=vkeys.up||vkeys.dn||vkeys.lt||vkeys.rt||keys['KeyA']||keys['KeyD']||keys['KeyW']||keys['KeyS']||keys['ArrowLeft']||keys['ArrowRight']||keys['ArrowUp']||keys['ArrowDown'];
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.35)';ctx.beginPath();ctx.ellipse(x,y+10,12,4,0,0,Math.PI*2);ctx.fill();
  // Legs
  const lo=Math.sin(gs.t/75)*2.5;
  ctx.fillStyle='#201410';
  ctx.fillRect(x-6,y+5,5,moving?10+lo:10);ctx.fillRect(x+1,y+5,5,moving?10-lo:10);
  // Coat
  ctx.fillStyle='#2c2018';ctx.fillRect(x-8,y-12,16,20);
  ctx.fillStyle='#381010';ctx.fillRect(x-8,y-12,3,13);ctx.fillRect(x+5,y-12,3,13);
  ctx.fillStyle='#801818';ctx.fillRect(x-1,y-10,2,10);
  ctx.fillStyle='#2c2018';ctx.fillRect(x-10,y-12,3,5);ctx.fillRect(x+7,y-12,3,5);
  // Head
  ctx.fillStyle='#c8a060';ctx.fillRect(x-6,y-22,12,12);
  ctx.fillStyle='rgba(0,0,0,0.2)';ctx.fillRect(x-6,y-14,12,4);
  // Hat
  ctx.fillStyle='#141010';ctx.fillRect(x-9,y-24,18,4);
  ctx.fillStyle='#181210';ctx.fillRect(x-6,y-34,12,12);
  ctx.fillStyle='#800000';ctx.fillRect(x-6,y-24,12,3);
  // Eyes
  ctx.fillStyle='#d4a828';ctx.fillRect(x-4,y-18,3,3);ctx.fillRect(x+1,y-18,3,3);
  // Cigarette
  ctx.fillStyle='#d4d4a0';ctx.fillRect(x+6,y-15,7,2);
  ctx.fillStyle='#ff6020';ctx.shadowColor='#ff6020';ctx.shadowBlur=4;ctx.fillRect(x+13,y-16,3,3);ctx.shadowBlur=0;
  // Club
  if(p.atkOn){
    const angles=[0,Math.PI/2,Math.PI,-Math.PI/2];
    ctx.save();ctx.translate(x,y);ctx.rotate(angles[p.facing]);
    ctx.fillStyle='#5a2808';ctx.fillRect(14,-3,24,5);ctx.fillStyle='#8a4010';ctx.fillRect(35,-5,12,10);ctx.restore();
    ctx.strokeStyle='rgba(220,170,40,0.45)';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(x,y,42,0,Math.PI*2);ctx.stroke();
  } else {
    ctx.fillStyle='#5a2808';ctx.fillRect(x+8,y-7,4,20);ctx.fillStyle='#8a4010';ctx.fillRect(x+7,y+11,6,7);
  }
}

function drawEnemy(e){
  const x=e.x,y=e.y,s=e.size,hit=Date.now()-e.hit<200,col=hit?'#fff':e.color;
  ctx.fillStyle='rgba(0,0,0,0.28)';ctx.beginPath();ctx.ellipse(x,y+s,s*.75,s*.28,0,0,Math.PI*2);ctx.fill();
  if(e.name==='Ğ“Ğ¾Ğ»ÑƒĞ±ÑŒ'){
    const wf=Math.sin(gs.t/110)*5;
    ctx.fillStyle=col;ctx.beginPath();ctx.ellipse(x,y,s,s*.52,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(x-s,y-2+wf,s*.65,s*.28,-0.3,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(x+s,y-2-wf,s*.65,s*.28,0.3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#f8f8f0';ctx.beginPath();ctx.arc(x+s*.7,y-s*.4,s*.42,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#e03030';ctx.beginPath();ctx.arc(x+s+3,y-s*.4,2,0,Math.PI*2);ctx.fill();
  } else if(e.name==='Ğ¯Ğ³Ğ½Ñ‘Ğ½Ğ¾Ğº'){
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(x,y,s,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=hit?'#eee':'#ecdeba';
    for(let i=0;i<7;i++){const a=(i/7)*Math.PI*2;ctx.beginPath();ctx.arc(x+Math.cos(a)*s*.62,y+Math.sin(a)*s*.62,3.5,0,Math.PI*2);ctx.fill();}
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(x+s*.8,y-s*.5,s*.48,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#201010';ctx.fillRect(x+s*.9,y-s*.8,2,4);ctx.fillRect(x+s*1.1,y-s*.8,2,4);
  } else {
    ctx.fillStyle='rgba(180,210,255,0.3)';
    ctx.beginPath();ctx.ellipse(x-s*1.5,y-3,s,s*.5,-0.25,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(x+s*1.5,y-3,s,s*.5,0.25,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(x,y,s,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=hit?'#fff':'rgba(230,240,255,0.85)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.ellipse(x,y-s-3,s*.65,s*.2,0,0,Math.PI*2);ctx.stroke();
  }
  if(e.hp<e.maxHp){ctx.fillStyle='#400';ctx.fillRect(x-s,y+s+2,s*2,3);ctx.fillStyle='#e03030';ctx.fillRect(x-s,y+s+2,s*2*(e.hp/e.maxHp),3);}
  ctx.fillStyle='rgba(210,185,145,0.7)';ctx.font='7px Courier New';ctx.textAlign='center';ctx.textBaseline='alphabetic';ctx.fillText(e.name,x,y-s-5);
}

function drawRain(){
  for(const d of gs.rain){
    ctx.strokeStyle=`rgba(150,180,230,${d.o})`;ctx.lineWidth=0.7;
    ctx.beginPath();ctx.moveTo(d.x,d.y);ctx.lineTo(d.x-2,d.y+d.l);ctx.stroke();
    d.y+=d.s;if(d.y>GH+d.l){d.y=-d.l;d.x=Math.random()*GW;}
  }
  // Vignette
  const v=ctx.createRadialGradient(GW/2,GH/2,GH*.15,GW/2,GH/2,GH*.7);
  v.addColorStop(0,'transparent');v.addColorStop(1,'rgba(0,0,0,0.5)');
  ctx.fillStyle=v;ctx.fillRect(0,0,GW,GH);
}

function drawHUD(){
  // Top bar
  ctx.fillStyle='rgba(8,6,3,0.92)';ctx.fillRect(0,0,GW,26);
  ctx.strokeStyle='#3a2810';ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(0,26);ctx.lineTo(GW,26);ctx.stroke();
  // HP
  const p=gs.player;
  for(let i=0;i<p.maxHp;i++){ctx.fillStyle=i<p.hp?'#d02020':'#301010';ctx.fillRect(8+i*13,6,10,10);}
  // Sin count
  const dc=discoveredCount();
  ctx.fillStyle=dc===7?'#d4a828':'#6a4a2a';
  ctx.font=dc===7?'bold 10px Courier New':'9px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(dc===7?'âšœ Ğ’Ğ¡Ğ• Ğ“Ğ Ğ•Ğ¥Ğ˜ ĞĞ¢ĞšĞ Ğ«Ğ¢Ğ« âšœ':'Ğ“Ğ Ğ•Ğ¥Ğ˜: '+dc+' / 7',GW/2,13);
  // Sin icons top-right
  for(let i=6;i>=0;i--){
    const rx=GW-6-(6-i)*28;
    ctx.fillStyle=gs.discovered[i]?SINS[i].color:unlocked(i)?'#201810':'#100e08';
    ctx.fillRect(rx-22,4,20,18);
    ctx.strokeStyle=gs.discovered[i]?SINS[i].glow:'#2a1a08';ctx.lineWidth=1;ctx.strokeRect(rx-22,4,20,18);
    ctx.font='11px serif';ctx.textAlign='center';ctx.textBaseline='middle';
    if(gs.discovered[i])ctx.fillText(SINS[i].sym,rx-12,13);
    else if(unlocked(i)){ctx.fillStyle='#4a3020';ctx.font='9px Courier New';ctx.fillText('?',rx-12,13);}
    else{ctx.fillStyle='#201810';ctx.fillText('âœ–',rx-12,13);}
  }
  ctx.textBaseline='alphabetic';
  // Selected seed bottom bar
  ctx.fillStyle='rgba(8,6,3,0.9)';ctx.fillRect(0,GH-22,GW,22);
  ctx.strokeStyle='#2a1e0c';ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(0,GH-22);ctx.lineTo(GW,GH-22);ctx.stroke();
  const ss=gs.player.sel,sinS=SINS[ss];
  ctx.fillStyle=unlocked(ss)?sinS.color:'#4a3a2a';ctx.font='bold 9px Courier New';ctx.textAlign='left';ctx.textBaseline='middle';
  ctx.fillText('â—† '+sinS.sym+' '+sinS.name+' â€” Ã—'+gs.seeds[ss]+' ÑˆÑ‚.',8,GH-11);
  ctx.fillStyle='#4a3a2a';ctx.font='8px Courier New';ctx.textAlign='right';
  ctx.fillText('E=Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ  ĞŸĞ ĞĞ‘Ğ•Ğ›=ÑƒĞ´Ğ°Ñ€  TAB=Ğ»Ğ°Ğ²ĞºĞ°',GW-8,GH-11);
  ctx.textBaseline='alphabetic';
}

function drawShop(){
  ctx.fillStyle='rgba(0,0,0,0.84)';ctx.fillRect(0,0,GW,GH);
  const sw=Math.min(560,GW-20),sh=Math.min(400,GH-20);
  const sx=(GW-sw)/2,sy=(GH-sh)/2;
  ctx.fillStyle='#140808';ctx.fillRect(sx,sy,sw,sh);
  ctx.strokeStyle='#8a1010';ctx.lineWidth=2;ctx.strokeRect(sx,sy,sw,sh);
  ctx.strokeStyle='#4a0808';ctx.lineWidth=1;ctx.strokeRect(sx+3,sy+3,sw-6,sh-6);
  // Header
  ctx.fillStyle='#8a1010';ctx.fillRect(sx,sy,sw,30);
  ctx.strokeStyle='#d4a828';ctx.lineWidth=1;ctx.strokeRect(sx,sy,sw,30);
  ctx.fillStyle='#d4a828';ctx.font='bold 13px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('âšœ  Ğ›ĞĞ’ĞšĞ Ğ¡Ğ•ĞœĞ¯Ğ Ğ“Ğ Ğ•Ğ¥Ğ  âšœ',sx+sw/2,sy+15);
  ctx.fillStyle='#d4a828';ctx.font='bold 11px Courier New';ctx.textAlign='left';ctx.textBaseline='alphabetic';
  ctx.fillText('ĞœĞ¾Ğ½ĞµÑ‚Ñ‹: '+gs.coins+' ğŸª™',sx+12,sy+sh-8);
  ctx.fillStyle='#4a3820';ctx.font='8px Courier New';ctx.textAlign='right';
  ctx.fillText('â–²â–¼=Ğ²Ñ‹Ğ±Ğ¾Ñ€  ĞšĞ£ĞŸĞ˜Ğ¢Ğ¬/Ğ¡Ğ”ĞĞ¢Ğ¬  TAB=Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ',sx+sw-10,sy+sh-8);
  const rowH=Math.floor((sh-46)/7);
  for(let i=0;i<7;i++){
    const row=sy+34+i*rowH,sel=gs.shop.sel===i,unl=unlocked(i);
    ctx.fillStyle=sel?'#240c0c':'#100606';ctx.fillRect(sx+6,row,sw-12,rowH-2);
    if(sel){ctx.strokeStyle='#8a1010';ctx.lineWidth=1;ctx.strokeRect(sx+6,row,sw-12,rowH-2);}
    ctx.fillStyle=unl?SINS[i].color:'#281010';ctx.fillRect(sx+12,row+4,26,rowH-10);
    ctx.font='13px serif';ctx.textAlign='center';ctx.textBaseline='middle';
    if(unl)ctx.fillText(SINS[i].sym,sx+25,row+rowH/2);
    else{ctx.fillStyle='#401818';ctx.fillText('ğŸ”’',sx+25,row+rowH/2);}
    if(!unl){ctx.fillStyle='#4a2020';ctx.font='9px Courier New';ctx.textAlign='left';ctx.textBaseline='alphabetic';ctx.fillText('Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Â«'+(SINS[i-1]?.name||'')+'Â»',sx+46,row+rowH/2+4);continue;}
    ctx.fillStyle=gs.discovered[i]?SINS[i].glow:'#c0a060';ctx.font='bold 11px Courier New';ctx.textAlign='left';ctx.textBaseline='alphabetic';
    ctx.fillText(SINS[i].name+' ('+SINS[i].en+')',sx+46,row+rowH/2-2);
    ctx.fillStyle='#807060';ctx.font='8px Courier New';
    ctx.fillText('ğŸŒ±'+SINS[i].seedCost+'  ğŸ’°'+SINS[i].sellPrice+'  â±'+SINS[i].growTime+'Ñ',sx+46,row+rowH/2+10);
    if(gs.discovered[i]){ctx.fillStyle='#60a040';ctx.fillText('âœ“ ĞĞ¢ĞšĞ Ğ«Ğ¢',sx+46,row+rowH-6);}
    ctx.fillStyle='#d4a828';ctx.font='bold 13px Courier New';ctx.textAlign='right';ctx.textBaseline='middle';
    ctx.fillText('Ã—'+gs.seeds[i],sx+sw-12,row+rowH/2);
  }
  ctx.textBaseline='alphabetic';
}

function drawNotify(){
  if(!gs.notify)return;
  const d=gs.notify,sin=SINS[d.sinId],el=Date.now()-d.start;
  const alpha=el<400?el/400:el>3500?1-(el-3500)/500:1;
  ctx.save();ctx.globalAlpha=alpha;
  ctx.fillStyle='rgba(0,0,0,0.88)';ctx.fillRect(GW/2-200,GH/2-80,400,160);
  ctx.strokeStyle=sin.color;ctx.lineWidth=2;ctx.strokeRect(GW/2-200,GH/2-80,400,160);
  ctx.fillStyle='#6a5a3a';ctx.font='10px Courier New';ctx.textAlign='center';ctx.textBaseline='alphabetic';
  ctx.fillText('â—†â—†â—†  ĞĞĞ’Ğ«Ğ™ Ğ“Ğ Ğ•Ğ¥ ĞĞ¢ĞšĞ Ğ«Ğ¢  â—†â—†â—†',GW/2,GH/2-50);
  ctx.shadowColor=sin.glow;ctx.shadowBlur=22;
  ctx.fillStyle=sin.color;ctx.font='bold 26px Courier New';ctx.fillText(sin.sym+'  '+sin.name,GW/2,GH/2-5);ctx.shadowBlur=0;
  ctx.fillStyle='#907a5a';ctx.font='13px Courier New';ctx.fillText('"'+sin.en+'"',GW/2,GH/2+18);
  ctx.fillStyle='#5a4a30';ctx.font='9px Courier New';ctx.fillText('Ğ¡ĞµĞ¼ĞµĞ½Ğ° Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»Ğ¸ÑÑŒ Ğ² Ğ»Ğ°Ğ²ĞºĞµ Ğ³Ñ€ĞµÑ…Ğ¾Ğ²',GW/2,GH/2+44);
  ctx.restore();
}

function drawDead(){
  ctx.fillStyle='rgba(0,0,0,0.8)';ctx.fillRect(0,0,GW,GH);
  ctx.shadowColor='#cc0000';ctx.shadowBlur=40;ctx.fillStyle='#aa1010';ctx.font='bold 48px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Ğ¢Ğ« ĞŸĞĞ›',GW/2,GH/2-35);ctx.shadowBlur=0;
  ctx.fillStyle='#5a3030';ctx.font='13px Courier New';ctx.fillText('Ğ¡Ñ‚Ñ€Ğ°Ğ¶Ğ¸ Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ´ĞµÑ‚ĞµĞ»Ğ¸ Ğ²Ğ·ÑĞ»Ğ¸ Ğ²ĞµÑ€Ñ…...',GW/2,GH/2+10);
  ctx.fillStyle='#3a2020';ctx.font='10px Courier New';ctx.fillText('ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾',GW/2,GH/2+45);ctx.textBaseline='alphabetic';
}

function drawWin(){
  ctx.fillStyle='rgba(0,0,0,0.9)';ctx.fillRect(0,0,GW,GH);
  ctx.shadowColor='#a040f0';ctx.shadowBlur=50;ctx.fillStyle='#6010a0';ctx.font='bold 42px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Ğ’Ğ¡Ğ• 7 Ğ“Ğ Ğ•Ğ¥ĞĞ’',GW/2,GH/2-75);
  ctx.shadowBlur=12;ctx.fillStyle='#d4a828';ctx.font='bold 20px Courier New';ctx.fillText('ĞŸĞĞ—ĞĞĞĞ«',GW/2,GH/2-40);ctx.shadowBlur=0;
  ctx.fillStyle='#6a5a7a';ctx.font='11px Courier New';ctx.fillText('Ğ¢Ñ‹ Ğ·Ğ°Ğ³Ğ»ÑĞ½ÑƒĞ» Ğ² ÑĞ°Ğ¼ÑƒÑ Ñ‚ÑŒĞ¼Ñƒ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµÑ‡ĞµÑĞºĞ¾Ğ¹ Ğ´ÑƒÑˆĞ¸...',GW/2,GH/2-4);
  ctx.fillStyle='#d4a828';ctx.font='11px Courier New';ctx.fillText('ĞœĞ¾Ğ½ĞµÑ‚Ñ‹: '+gs.coins,GW/2,GH/2+22);
  SINS.forEach((s,i)=>{ctx.shadowColor=s.glow;ctx.shadowBlur=10;ctx.font='24px serif';ctx.fillText(s.sym,GW/2-84+i*28,GH/2+64);});
  ctx.shadowBlur=0;ctx.textBaseline='alphabetic';
}

// â”€â”€ Main loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let last=0;
function loop(ts){
  const dt=Math.min(ts-last,100);last=ts;gs.t+=dt;
  if(!gs.player.dead&&!gs.win&&!gs.shop.open){updatePlayer(dt);updatePlots();updateEnemies();updateSpawn(dt);}
  ctx.fillStyle='#131008';ctx.fillRect(0,0,GW,GH);
  drawMap();drawPlots();
  for(const e of gs.enemies)drawEnemy(e);
  drawPlayer();drawRain();drawHUD();
  if(gs.shop.open)drawShop();
  if(gs.notify)drawNotify();
  if(gs.player.dead)drawDead();
  if(gs.win)drawWin();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
