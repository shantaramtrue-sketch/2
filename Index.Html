<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>SIN FARM â€” Ğ¤ĞµÑ€Ğ¼Ğ° Ğ“Ñ€ĞµÑ…Ğ¾Ğ²</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html, body {
  background:#000;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  font-family:'Courier New',monospace;
  overflow:hidden;
}
#game-wrap { position:relative; }
canvas { display:block; cursor:crosshair; image-rendering:pixelated; }
#controls {
  color:#3a2a1a;
  font-size:10px;
  font-family:'Courier New',monospace;
  text-align:center;
  margin-top:4px;
  letter-spacing:1px;
}
</style>
</head>
<body>
<div id="game-wrap">
<canvas id="c"></canvas>
<div id="controls">WASD â€” Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ &nbsp;|&nbsp; E â€” Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ &nbsp;|&nbsp; ĞŸĞ ĞĞ‘Ğ•Ğ› â€” ÑƒĞ´Ğ°Ñ€ Ğ´ÑƒĞ±Ğ¸Ğ½Ğ¾Ğ¹ &nbsp;|&nbsp; 1-7 â€” Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑĞµĞ¼Ñ &nbsp;|&nbsp; TAB â€” Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½</div>
</div>
<script>
'use strict';

const C = document.getElementById('c');
const ctx = C.getContext('2d');
const W = C.width = 768;
const H = C.height = 528;
const TS = 48;

// â”€â”€â”€ SINS DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SINS = [
  { id:0, name:'Ğ›Ğ•ĞĞ¬',         en:'SLOTH',    color:'#7a6655', dark:'#3a2820', glow:'#9a8060', seedCost:15,   sellPrice:40,   growTime:18,  sym:'ğŸ’¤' },
  { id:1, name:'Ğ§Ğ Ğ•Ğ’ĞĞ£Ğ“ĞĞ”Ğ˜Ğ•', en:'GLUTTONY', color:'#9b4a18', dark:'#4a200a', glow:'#d06020', seedCost:40,   sellPrice:105,  growTime:30,  sym:'ğŸ—' },
  { id:2, name:'Ğ–ĞĞ”ĞĞĞ¡Ğ¢Ğ¬',     en:'GREED',    color:'#c0900a', dark:'#604500', glow:'#f0b020', seedCost:90,   sellPrice:240,  growTime:45,  sym:'ğŸ’°' },
  { id:3, name:'ĞŸĞĞ¥ĞĞ¢Ğ¬',       en:'LUST',     color:'#901020', dark:'#480010', glow:'#e03050', seedCost:220,  sellPrice:580,  growTime:65,  sym:'ğŸŒ¹' },
  { id:4, name:'Ğ—ĞĞ’Ğ˜Ğ¡Ğ¢Ğ¬',      en:'ENVY',     color:'#2a6020', dark:'#103010', glow:'#40a030', seedCost:540,  sellPrice:1400, growTime:90,  sym:'ğŸ' },
  { id:5, name:'Ğ“ĞĞ•Ğ’',         en:'WRATH',    color:'#c82000', dark:'#600800', glow:'#ff4010', seedCost:1300, sellPrice:3300, growTime:120, sym:'ğŸ”¥' },
  { id:6, name:'Ğ“ĞĞ Ğ”Ğ«ĞĞ¯',      en:'PRIDE',    color:'#5a0a90', dark:'#220040', glow:'#9030e0', seedCost:3000, sellPrice:7500, growTime:160, sym:'ğŸ‘‘' },
];

// â”€â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 16Ã—11 tiles. 0=path 1=soil 2=shop 3=wall 4=corner_deco
const MAP = [
  [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
  [3,2,2,2,3,1,1,1,1,0,1,1,1,1,3,3],
  [3,2,2,2,3,1,1,1,1,0,1,1,1,1,3,3],
  [3,2,2,2,3,1,1,1,1,0,1,1,1,1,3,3],
  [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
  [3,0,0,0,0,1,1,1,1,0,1,1,1,1,0,3],
  [3,0,0,0,0,1,1,1,1,0,1,1,1,1,0,3],
  [3,0,0,0,0,1,1,1,1,0,1,1,1,1,0,3],
  [3,0,0,0,0,1,1,1,1,0,1,1,1,1,0,3],
  [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
  [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
];
const ROWS=11, COLS=16;

// Farm plot tiles
const PLOT_COORDS=[];
for(let r=1;r<=3;r++){for(let c=5;c<=8;c++)PLOT_COORDS.push([c,r]);for(let c=10;c<=13;c++)PLOT_COORDS.push([c,r]);}
for(let r=5;r<=8;r++){for(let c=5;c<=8;c++)PLOT_COORDS.push([c,r]);for(let c=10;c<=13;c++)PLOT_COORDS.push([c,r]);}

// â”€â”€â”€ ENEMY TYPES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ENEMY_TYPES=[
  {name:'Ğ“Ğ¾Ğ»ÑƒĞ±ÑŒ',   maxHp:1,speed:0.75,reward:8, color:'#e0e0d8',size:12,cropDmg:8, playerDmg:1,unlockAt:0},
  {name:'Ğ¯Ğ³Ğ½Ñ‘Ğ½Ğ¾Ğº',  maxHp:2,speed:0.95,reward:18,color:'#d4c080',size:15,cropDmg:14,playerDmg:1,unlockAt:1},
  {name:'Ğ¡Ñ‚Ñ€Ğ°Ğ¶',   maxHp:4,speed:1.15,reward:35,color:'#b0c4e0',size:18,cropDmg:20,playerDmg:2,unlockAt:3},
];

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const gs={
  coins:50,
  seeds:new Array(7).fill(0),
  discovered:new Array(7).fill(false),
  plots:PLOT_COORDS.map(([x,y])=>({x,y,sinId:-1,plantedAt:0,stage:0,health:100})),
  player:{x:2.5*TS,y:6.5*TS,hp:10,maxHp:10,facing:0,atkTimer:0,atkOn:false,invTimer:0,regenTimer:0,dead:false,selectedSeed:0},
  enemies:[],
  rain:Array.from({length:220},()=>({x:Math.random()*W,y:Math.random()*H,s:1.5+Math.random()*3,l:8+Math.random()*20,o:0.05+Math.random()*0.12})),
  shop:{open:false,sel:0},
  notify:null,
  spawnT:0,
  t:0,
  win:false,
};

// â”€â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const keys={};
document.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='Tab'){e.preventDefault();if(!gs.player.dead&&!gs.win)gs.shop.open=!gs.shop.open;}
  if(e.code==='Space'){e.preventDefault();attack();}
  if(e.code==='KeyE')interact();
  if(gs.shop.open){
    if(e.code==='ArrowUp'||e.code==='KeyW')gs.shop.sel=Math.max(0,gs.shop.sel-1);
    if(e.code==='ArrowDown'||e.code==='KeyS')gs.shop.sel=Math.min(6,gs.shop.sel+1);
    if(e.code==='KeyB')buyItem();
    if(e.code==='KeyV')sellItem();
  }
  for(let i=1;i<=7;i++)if(e.code==='Digit'+i){gs.player.selectedSeed=i-1;}
});
document.addEventListener('keyup',e=>keys[e.code]=false);

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function unlocked(id){return id===0||gs.discovered[id-1];}
function discoveredCount(){return gs.discovered.filter(Boolean).length;}

function notify(sinId){
  gs.notify={sinId,start:Date.now()};
  setTimeout(()=>{if(gs.notify&&gs.notify.sinId===sinId)gs.notify=null;},4000);
}

// â”€â”€â”€ ATTACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function attack(){
  const p=gs.player;
  if(gs.shop.open||p.dead)return;
  const now=Date.now();
  if(now-p.atkTimer<450)return;
  p.atkTimer=now;p.atkOn=true;
  setTimeout(()=>p.atkOn=false,220);
  const reach=52;
  const dirs=[[1,0],[0,1],[-1,0],[0,-1]];
  const [dx,dy]=dirs[p.facing];
  const ax=p.x+dx*30,ay=p.y+dy*30;
  gs.enemies=gs.enemies.filter(e=>{
    const d=Math.hypot(e.x-ax,e.y-ay);
    if(d<reach){e.hp-=2;e.hit=Date.now();if(e.hp<=0){gs.coins+=e.reward;return false;}}
    return true;
  });
}

// â”€â”€â”€ INTERACT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function interact(){
  if(gs.shop.open||gs.player.dead)return;
  const p=gs.player;
  const px=Math.floor(p.x/TS),py=Math.floor(p.y/TS);
  for(const plot of gs.plots){
    if(Math.abs(plot.x-px)<=1&&Math.abs(plot.y-py)<=1){
      if(plot.stage===3){
        // Harvest
        const sin=SINS[plot.sinId];
        const earned=Math.floor(sin.sellPrice*(plot.health/100));
        gs.coins+=earned;
        if(!gs.discovered[plot.sinId]){gs.discovered[plot.sinId]=true;notify(plot.sinId);}
        if(gs.discovered.every(Boolean))setTimeout(()=>gs.win=true,2500);
        plot.stage=0;plot.sinId=-1;plot.health=100;
        return;
      }
      if(plot.stage===0){
        // Plant selected seed type if available
        const sid=p.selectedSeed;
        if(unlocked(sid)&&gs.seeds[sid]>0){
          plot.sinId=sid;plot.stage=1;plot.plantedAt=Date.now();plot.health=100;
          gs.seeds[sid]--;return;
        }
        // Fallback: find any available seed
        for(let i=0;i<7;i++){
          if(unlocked(i)&&gs.seeds[i]>0){
            plot.sinId=i;plot.stage=1;plot.plantedAt=Date.now();plot.health=100;
            gs.seeds[i]--;return;
          }
        }
      }
      return;
    }
  }
}

function buyItem(){
  const id=gs.shop.sel;
  if(!unlocked(id))return;
  if(gs.coins>=SINS[id].seedCost){gs.coins-=SINS[id].seedCost;gs.seeds[id]++;}
}
function sellItem(){
  const id=gs.shop.sel;
  if(gs.seeds[id]>0){gs.seeds[id]--;gs.coins+=Math.floor(SINS[id].seedCost*0.5);}
}

// â”€â”€â”€ COLLISION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isWall(px,py){
  const m=10;
  const pts=[[px-m,py-m],[px+m,py-m],[px-m,py+m],[px+m,py+m]];
  for(const[x,y]of pts){
    const tc=Math.floor(x/TS),tr=Math.floor(y/TS);
    if(tr<0||tr>=ROWS||tc<0||tc>=COLS)return true;
    const t=MAP[tr][tc];
    if(t===3||t===2)return true;
  }
  return false;
}

// â”€â”€â”€ UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePlayer(dt){
  const p=gs.player;
  if(p.dead||gs.shop.open)return;
  const sp=2.6;
  let dx=0,dy=0;
  if(keys['KeyA']||keys['ArrowLeft']){dx-=sp;p.facing=2;}
  if(keys['KeyD']||keys['ArrowRight']){dx+=sp;p.facing=0;}
  if(keys['KeyW']||keys['ArrowUp']){dy-=sp;p.facing=3;}
  if(keys['KeyS']||keys['ArrowDown']){dy+=sp;p.facing=1;}
  if(dx&&dy){dx*=0.707;dy*=0.707;}
  if(!isWall(p.x+dx,p.y))p.x+=dx;
  if(!isWall(p.x,p.y+dy))p.y+=dy;
  p.x=Math.max(TS+12,Math.min(W-TS-12,p.x));
  p.y=Math.max(TS+12,Math.min(H-TS-12,p.y));
  if(p.invTimer>0)p.invTimer-=dt;
  p.regenTimer+=dt;
  if(p.regenTimer>5000){p.regenTimer=0;p.hp=Math.min(p.maxHp,p.hp+1);}
}

function updatePlots(){
  const now=Date.now();
  for(const p of gs.plots){
    if(p.stage<1||p.stage>=3)continue;
    const elapsed=(now-p.plantedAt)/1000;
    const gt=SINS[p.sinId].growTime;
    if(elapsed>=gt)p.stage=3;
    else if(elapsed>=gt*0.5)p.stage=2;
    else p.stage=1;
  }
}

function updateEnemies(dt){
  const now=Date.now();
  const p=gs.player;
  for(const e of gs.enemies){
    // Find nearest living crop
    let target=null,td=9999;
    for(const pl of gs.plots){
      if(pl.stage<1)continue;
      const d=Math.hypot(pl.x*TS+24-e.x,pl.y*TS+24-e.y);
      if(d<td){td=d;target=pl;}
    }
    if(target&&td<320){
      const tx=target.x*TS+24,ty=target.y*TS+24;
      const d=Math.hypot(tx-e.x,ty-e.y);
      if(d>22){const r=e.speed;e.x+=(tx-e.x)/d*r;e.y+=(ty-e.y)/d*r;}
      else if(now-e.atkT>1100){e.atkT=now;target.health-=e.cropDmg;if(target.health<=0){target.stage=0;target.sinId=-1;target.health=100;}}
    } else {
      if(now-e.wT>2500){e.wT=now;const pts=[[1,4],[7,4],[13,4],[1,9],[7,9],[13,9],[7,6],[4,7]];const pt=pts[Math.random()*pts.length|0];e.wx=pt[0]*TS+24+(Math.random()-.5)*30;e.wy=pt[1]*TS+24+(Math.random()-.5)*30;}
      const d=Math.hypot(e.wx-e.x,e.wy-e.y);
      if(d>6){e.x+=(e.wx-e.x)/d*e.speed*0.5;e.y+=(e.wy-e.y)/d*e.speed*0.5;}
    }
    // Damage player
    if(p.invTimer<=0&&Math.hypot(p.x-e.x,p.y-e.y)<22){
      p.hp-=e.playerDmg;p.invTimer=1200;
      if(p.hp<=0){p.hp=0;p.dead=true;}
    }
  }
}

function updateSpawn(dt){
  gs.spawnT+=dt;
  const dc=discoveredCount();
  const interval=Math.max(7000,22000-dc*2000);
  const maxE=4+dc;
  if(gs.spawnT>interval&&gs.enemies.length<maxE){
    gs.spawnT=0;spawnEnemy(dc);}
}

function spawnEnemy(dc){
  const avail=ENEMY_TYPES.filter(t=>dc>=t.unlockAt);
  const type=avail[Math.random()*avail.length|0];
  const pts=[[1,4],[14,4],[1,9],[14,9],[7,9]];
  const sp=pts[Math.random()*pts.length|0];
  gs.enemies.push({
    x:sp[0]*TS+24,y:sp[1]*TS+24,
    hp:type.maxHp,maxHp:type.maxHp,
    speed:type.speed,reward:type.reward,color:type.color,size:type.size,
    cropDmg:type.cropDmg,playerDmg:type.playerDmg,name:type.name,
    atkT:0,wT:0,wx:sp[0]*TS+24,wy:sp[1]*TS+24,hit:0,
  });
}

// â”€â”€â”€ DRAWING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawTile(c,r){
  const x=c*TS,y=r*TS,t=MAP[r][c];
  if(t===3){
    ctx.fillStyle='#090705';ctx.fillRect(x,y,TS,TS);
    ctx.fillStyle='#0f0c08';ctx.fillRect(x+1,y+1,TS-2,TS-2);
    // grime lines
    ctx.fillStyle='#0a0806';
    for(let i=0;i<3;i++){ctx.fillRect(x+(c*13+i*17)%TS,y+(r*11+i*7)%TS,1,2);}
  } else if(t===0){
    ctx.fillStyle='#0e0c08';ctx.fillRect(x,y,TS,TS);
    ctx.fillStyle='#100e09';
    for(let i=0;i<6;i++){const rx=(c*7+i*13)%TS,ry=(r*11+i*9)%TS;ctx.fillRect(x+rx,y+ry,1,1);}
  } else if(t===1){
    ctx.fillStyle='#1a1008';ctx.fillRect(x,y,TS,TS);
    ctx.fillStyle='#211408';ctx.fillRect(x+3,y+3,TS-6,TS-6);
    ctx.fillStyle='#180e06';ctx.fillRect(x+6,y+6,TS-12,TS-12);
  } else if(t===2){
    ctx.fillStyle='#130505';ctx.fillRect(x,y,TS,TS);
  }
}

function drawMap(){
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)drawTile(c,r);

  // Shop building
  ctx.fillStyle='#1c0808';
  ctx.fillRect(TS,TS,3*TS,3*TS);
  ctx.strokeStyle='#6a0000';ctx.lineWidth=2;
  ctx.strokeRect(TS+1,TS+1,3*TS-2,3*TS-2);
  ctx.strokeStyle='#3a0808';ctx.lineWidth=1;
  ctx.strokeRect(TS+5,TS+5,3*TS-10,3*TS-10);

  // Shop sign board
  ctx.fillStyle='#6a0000';ctx.fillRect(TS+8,TS+8,3*TS-16,24);
  ctx.strokeStyle='#c8a020';ctx.lineWidth=1;
  ctx.strokeRect(TS+8,TS+8,3*TS-16,24);
  ctx.fillStyle='#c8a020';ctx.font='bold 10px Courier New';
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('âšœ Ğ›ĞĞ’ĞšĞ Ğ“Ğ Ğ•Ğ¥ĞĞ’ âšœ',TS+1.5*TS,TS+20);

  // Windows
  const wx=[TS+10,TS+3*TS-26];
  for(const wx_ of wx){
    ctx.fillStyle='#0a0505';ctx.fillRect(wx_,TS+36,16,16);
    ctx.strokeStyle='#3a1010';ctx.lineWidth=1;
    ctx.strokeRect(wx_,TS+36,16,16);
    ctx.fillStyle='rgba(60,10,10,0.5)';ctx.fillRect(wx_+2,TS+38,12,12);
  }

  // Door
  const dx=TS+TS+12;
  ctx.fillStyle='#2a0a0a';ctx.fillRect(dx,3*TS+6,22,28);
  ctx.strokeStyle='#5a1818';ctx.lineWidth=1;ctx.strokeRect(dx,3*TS+6,22,28);
  ctx.fillStyle='#c8a020';ctx.beginPath();ctx.arc(dx+17,3*TS+21,2,0,Math.PI*2);ctx.fill();

  // TAB hint
  ctx.fillStyle='#4a2020';ctx.font='9px Courier New';ctx.textAlign='center';ctx.textBaseline='alphabetic';
  ctx.fillText('[TAB]',TS+1.5*TS,4*TS+16);

  // Soil grid lines
  ctx.strokeStyle='rgba(60,35,10,0.25)';ctx.lineWidth=0.5;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)
    if(MAP[r][c]===1){ctx.strokeRect(c*TS,r*TS,TS,TS);}

  // Fence posts at map border
  ctx.fillStyle='#2a1a08';
  for(let c=0;c<COLS;c++){ctx.fillRect(c*TS+22,0,4,4);ctx.fillRect(c*TS+22,H-4,4,4);}
}

function drawPlots(){
  const now=Date.now();
  for(const pl of gs.plots){
    if(pl.stage===0)continue;
    const sin=SINS[pl.sinId];
    const px=pl.x*TS,py=pl.y*TS;
    const cx=px+TS/2,cy=py+TS/2;
    const hp=pl.health/100;

    // Damage tint
    if(hp<1){
      ctx.fillStyle=`rgba(160,0,0,${(1-hp)*0.45})`;
      ctx.fillRect(px,py,TS,TS);
    }

    if(pl.stage===1){
      // Seedling: small mound
      ctx.fillStyle=sin.dark;
      ctx.beginPath();ctx.ellipse(cx,cy+4,12,6,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=sin.color;
      ctx.beginPath();ctx.arc(cx,cy-2,6,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=sin.dark;ctx.fillRect(cx-1,cy+2,2,6);
    } else if(pl.stage===2){
      // Growing: multi-layer shape
      ctx.fillStyle=sin.dark;ctx.fillRect(cx-12,cy-8,24,22);
      ctx.fillStyle=sin.color;ctx.fillRect(cx-9,cy-16,18,18);
      ctx.fillStyle=sin.dark;ctx.fillRect(cx-5,cy-22,10,10);
      ctx.fillStyle=sin.glow;ctx.fillRect(cx-3,cy-18,6,6);
    } else {
      // Ready: glowing orb
      const pulse=0.65+0.35*Math.sin(gs.t/280);
      ctx.shadowColor=sin.glow;ctx.shadowBlur=18*pulse;
      ctx.fillStyle=sin.color;
      ctx.beginPath();ctx.arc(cx,cy,16,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=6;ctx.fillStyle=sin.glow;
      ctx.beginPath();ctx.arc(cx,cy-2,9,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;
      ctx.font='15px serif';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(sin.sym,cx,cy);ctx.textBaseline='alphabetic';
      ctx.fillStyle='#c8a020';ctx.font='bold 9px Courier New';ctx.textAlign='center';
      ctx.fillText('[E]',cx,py+8);
    }

    // Seed label
    ctx.fillStyle='rgba(120,80,40,0.8)';ctx.font='8px Courier New';ctx.textAlign='center';
    ctx.fillText(sin.en.slice(0,5),cx,py+TS-4);

    // HP bar
    if(hp<1){
      ctx.fillStyle='#300';ctx.fillRect(px+4,py+TS-9,TS-8,4);
      ctx.fillStyle='#c00';ctx.fillRect(px+4,py+TS-9,(TS-8)*hp,4);
    }
  }
}

function drawPlayer(){
  const p=gs.player;
  const x=p.x,y=p.y;
  if(p.dead)return;
  if(p.invTimer>0&&Math.floor(Date.now()/80)%2)return;

  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.45)';
  ctx.beginPath();ctx.ellipse(x,y+12,14,5,0,0,Math.PI*2);ctx.fill();

  // Legs
  const legOsc=Math.sin(gs.t/80)*3;
  ctx.fillStyle='#151010';
  if(keys['KeyA']||keys['KeyD']||keys['KeyW']||keys['KeyS']){
    ctx.fillRect(x-7,y+6,6,12+legOsc);ctx.fillRect(x+1,y+6,6,12-legOsc);
  } else {ctx.fillRect(x-7,y+6,6,12);ctx.fillRect(x+1,y+6,6,12);}

  // Coat body
  ctx.fillStyle='#1c1410';ctx.fillRect(x-9,y-14,18,22);
  // Lapels
  ctx.fillStyle='#250a0a';ctx.fillRect(x-9,y-14,4,14);ctx.fillRect(x+5,y-14,4,14);
  // Shirt/tie stripe
  ctx.fillStyle='#601010';ctx.fillRect(x-1,y-12,2,12);

  // Shoulders (coat)
  ctx.fillStyle='#1c1410';ctx.fillRect(x-12,y-14,4,6);ctx.fillRect(x+8,y-14,4,6);

  // Head
  ctx.fillStyle='#b89050';ctx.fillRect(x-7,y-26,14,14);
  // Stubble / shadow on face
  ctx.fillStyle='rgba(0,0,0,0.25)';ctx.fillRect(x-7,y-16,14,5);

  // Hat brim
  ctx.fillStyle='#0a0808';ctx.fillRect(x-11,y-28,22,5);
  // Hat top
  ctx.fillStyle='#0d0a08';ctx.fillRect(x-7,y-40,14,14);
  // Hat band
  ctx.fillStyle='#6a0000';ctx.fillRect(x-7,y-28,14,3);

  // Eyes glow
  ctx.fillStyle='#c8a020';ctx.fillRect(x-5,y-22,3,3);ctx.fillRect(x+2,y-22,3,3);
  // Cigarette
  ctx.fillStyle='#c8c8a0';ctx.fillRect(x+7,y-18,8,2);
  ctx.fillStyle='#ff6020';ctx.fillRect(x+15,y-19,3,3);
  ctx.shadowColor='#ff6020';ctx.shadowBlur=4;ctx.fillRect(x+15,y-19,3,3);ctx.shadowBlur=0;

  // Club attack
  if(p.atkOn){
    const angles=[0,Math.PI/2,Math.PI,-Math.PI/2];
    ctx.save();ctx.translate(x,y);ctx.rotate(angles[p.facing]);
    ctx.fillStyle='#4a2005';ctx.fillRect(16,-3,28,6);
    ctx.fillStyle='#7a3a10';ctx.fillRect(40,-6,14,12);
    ctx.fillStyle='#5a2a08';ctx.fillRect(38,-5,4,10);
    ctx.restore();
    ctx.strokeStyle='rgba(200,160,30,0.5)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(x,y,46,0,Math.PI*2);ctx.stroke();
  } else {
    // Club at rest (held at side)
    ctx.fillStyle='#4a2005';ctx.fillRect(x+9,y-8,5,22);
    ctx.fillStyle='#7a3a10';ctx.fillRect(x+8,y+12,7,8);
  }
}

function drawEnemy(e){
  const x=e.x,y=e.y,s=e.size;
  const hit=Date.now()-e.hit<200;
  const col=hit?'#fff':e.color;

  ctx.fillStyle='rgba(0,0,0,0.35)';ctx.beginPath();ctx.ellipse(x,y+s,s*0.8,s*0.3,0,0,Math.PI*2);ctx.fill();

  if(e.name==='Ğ“Ğ¾Ğ»ÑƒĞ±ÑŒ'){
    const wf=Math.sin(gs.t/120)*6;
    ctx.fillStyle=col;
    ctx.beginPath();ctx.ellipse(x,y,s,s*0.55,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(x-s,y-3+wf,s*0.7,s*0.3,-0.3,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(x+s,y-3-wf,s*0.7,s*0.3,0.3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#f0f0f0';ctx.beginPath();ctx.arc(x+s*0.7,y-s*0.4,s*0.45,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#c00';ctx.beginPath();ctx.arc(x+s+4,y-s*0.4,2,0,Math.PI*2);ctx.fill();
  } else if(e.name==='Ğ¯Ğ³Ğ½Ñ‘Ğ½Ğ¾Ğº'){
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(x,y,s,0,Math.PI*2);ctx.fill();
    // Wool tufts
    ctx.fillStyle=hit?'#ddd':'#e0d4b0';
    for(let i=0;i<7;i++){const a=(i/7)*Math.PI*2;ctx.beginPath();ctx.arc(x+Math.cos(a)*s*0.65,y+Math.sin(a)*s*0.65,4,0,Math.PI*2);ctx.fill();}
    // Head
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(x+s*0.8,y-s*0.5,s*0.5,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#1a1010';ctx.fillRect(x+s*0.9,y-s*0.8,2,4);ctx.fillRect(x+s*1.1,y-s*0.8,2,4);
  } else {
    // Guardian Angel
    ctx.fillStyle='rgba(160,190,240,0.4)';
    ctx.beginPath();ctx.ellipse(x-s*1.6,y-4,s,s*0.55,-0.25,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(x+s*1.6,y-4,s,s*0.55,0.25,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(x,y,s,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=hit?'#fff':'rgba(220,230,255,0.9)';ctx.lineWidth=2;
    ctx.beginPath();ctx.ellipse(x,y-s-4,s*0.7,s*0.22,0,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle='#1a1a2a';ctx.fillRect(x-3,y-3,6,6);
    ctx.fillStyle='#e0f0ff';ctx.fillRect(x-2,y-2,4,4);
  }

  // HP bar
  if(e.hp<e.maxHp){
    ctx.fillStyle='#300';ctx.fillRect(x-s,y+s+2,s*2,3);
    ctx.fillStyle='#c00';ctx.fillRect(x-s,y+s+2,s*2*(e.hp/e.maxHp),3);
  }
  ctx.fillStyle='rgba(200,170,130,0.7)';ctx.font='8px Courier New';ctx.textAlign='center';ctx.textBaseline='alphabetic';
  ctx.fillText(e.name,x,y-s-7);
}

function drawRain(){
  for(const d of gs.rain){
    ctx.strokeStyle=`rgba(130,160,210,${d.o})`;ctx.lineWidth=0.8;
    ctx.beginPath();ctx.moveTo(d.x,d.y);ctx.lineTo(d.x-2,d.y+d.l);ctx.stroke();
    d.y+=d.s;if(d.y>H+d.l){d.y=-d.l;d.x=Math.random()*W;}
  }
  // Vignette
  const v=ctx.createRadialGradient(W/2,H/2,H*0.2,W/2,H/2,H*0.75);
  v.addColorStop(0,'transparent');v.addColorStop(1,'rgba(0,0,0,0.65)');
  ctx.fillStyle=v;ctx.fillRect(0,0,W,H);
}

function drawHUD(){
  // Top bar
  ctx.fillStyle='rgba(4,2,1,0.95)';ctx.fillRect(0,0,W,30);
  ctx.strokeStyle='#2a1808';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,30);ctx.lineTo(W,30);ctx.stroke();
  ctx.strokeStyle='#4a2a10';ctx.lineWidth=0.5;
  ctx.beginPath();ctx.moveTo(0,29);ctx.lineTo(W,29);ctx.stroke();

  // Coins
  ctx.fillStyle='#c8a020';ctx.font='bold 13px Courier New';ctx.textAlign='left';ctx.textBaseline='middle';
  ctx.fillText('ğŸ’° '+gs.coins,8,15);

  // HP hearts
  ctx.fillStyle='#5a3030';ctx.font='10px Courier New';
  ctx.fillText('HP',180,15);
  const p=gs.player;
  for(let i=0;i<p.maxHp;i++){
    ctx.fillStyle=i<p.hp?'#c02020':'#281010';
    ctx.fillRect(205+i*14,7,11,11);
  }

  // Sin count center
  const dc=discoveredCount();
  ctx.fillStyle=dc===7?'#c8a020':'#5a3a2a';
  ctx.font=dc===7?'bold 11px Courier New':'10px Courier New';
  ctx.textAlign='center';
  ctx.fillText(dc===7?'âšœ Ğ’Ğ¡Ğ• Ğ“Ğ Ğ•Ğ¥Ğ˜ ĞĞ¢ĞšĞ Ğ«Ğ¢Ğ« âšœ':'Ğ“Ğ Ğ•Ğ¥Ğ˜: '+dc+' / 7',W/2,15);

  // Sin status icons top right
  const startX=W-8-6*32;
  for(let i=6;i>=0;i--){
    const x=W-8-(6-i)*32;
    ctx.fillStyle=gs.discovered[i]?SINS[i].color:unlocked(i)?'#1a1210':'#0d0d0d';
    ctx.fillRect(x-26,4,24,22);
    ctx.strokeStyle=gs.discovered[i]?SINS[i].glow:'#2a1a10';ctx.lineWidth=1;
    ctx.strokeRect(x-26,4,24,22);
    ctx.font='13px serif';ctx.textAlign='center';ctx.textBaseline='middle';
    if(gs.discovered[i])ctx.fillText(SINS[i].sym,x-14,15);
    else if(unlocked(i)){ctx.fillStyle='#3a2818';ctx.font='10px Courier New';ctx.fillText('?',x-14,15);}
    else{ctx.fillStyle='#1a1010';ctx.fillText('âœ–',x-14,15);}
  }
  ctx.textBaseline='alphabetic';

  // Selected seed indicator (bottom left)
  ctx.fillStyle='rgba(4,2,1,0.9)';ctx.fillRect(0,H-28,W,28);
  ctx.strokeStyle='#1a1008';ctx.lineWidth=0.5;
  ctx.beginPath();ctx.moveTo(0,H-28);ctx.lineTo(W,H-28);ctx.stroke();
  const ss=gs.player.selectedSeed;
  const sinS=SINS[ss];
  ctx.fillStyle=unlocked(ss)?sinS.color:'#3a2a1a';
  ctx.font='bold 10px Courier New';ctx.textAlign='left';ctx.textBaseline='middle';
  ctx.fillText('â—† '+sinS.sym+' '+sinS.name+' (Ã—'+gs.seeds[ss]+')',8,H-14);
  ctx.fillStyle='#3a2a1a';ctx.font='9px Courier New';ctx.textAlign='center';
  ctx.fillText('WASD=Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ  E=Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ  ĞŸĞ ĞĞ‘Ğ•Ğ›=ÑƒĞ´Ğ°Ñ€  1-7=Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑĞµĞ¼Ñ  TAB=Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½',W/2,H-14);
}

function drawShop(){
  ctx.fillStyle='rgba(0,0,0,0.88)';ctx.fillRect(0,0,W,H);
  const sw=520,sh=440,sx=(W-sw)/2,sy=(H-sh)/2;

  // Window
  ctx.fillStyle='#0c0404';ctx.fillRect(sx,sy,sw,sh);
  ctx.strokeStyle='#7a0000';ctx.lineWidth=2;ctx.strokeRect(sx,sy,sw,sh);
  ctx.strokeStyle='#3a0a0a';ctx.lineWidth=1;ctx.strokeRect(sx+4,sy+4,sw-8,sh-8);

  // Header
  ctx.fillStyle='#7a0000';ctx.fillRect(sx,sy,sw,34);
  ctx.strokeStyle='#c8a020';ctx.lineWidth=1;ctx.strokeRect(sx,sy,sw,34);
  ctx.fillStyle='#c8a020';ctx.font='bold 14px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('âšœ  Ğ›ĞĞ’ĞšĞ Ğ¡Ğ•ĞœĞ¯Ğ Ğ“Ğ Ğ•Ğ¥Ğ  âšœ',sx+sw/2,sy+17);

  ctx.fillStyle='#c8a020';ctx.font='bold 12px Courier New';ctx.textAlign='left';ctx.textBaseline='alphabetic';
  ctx.fillText('ĞœĞ¾Ğ½ĞµÑ‚Ñ‹: '+gs.coins+'ğŸª™',sx+16,sy+sh-10);
  ctx.fillStyle='#3a2a1a';ctx.font='9px Courier New';ctx.textAlign='right';
  ctx.fillText('B=ĞºÑƒĞ¿Ğ¸Ñ‚ÑŒ  V=Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ(50%)  â†‘â†“=Ğ²Ñ‹Ğ±Ğ¾Ñ€  TAB=Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ',sx+sw-10,sy+sh-10);

  for(let i=0;i<7;i++){
    const row=sy+42+i*54;
    const sel=gs.shop.sel===i;
    const unl=unlocked(i);
    ctx.fillStyle=sel?'#1a0808':'#0e0505';ctx.fillRect(sx+8,row,sw-16,50);
    if(sel){ctx.strokeStyle='#7a0000';ctx.lineWidth=1;ctx.strokeRect(sx+8,row,sw-16,50);}

    // Color swatch
    ctx.fillStyle=unl?SINS[i].color:'#1a1010';ctx.fillRect(sx+16,row+9,30,32);
    if(unl){
      ctx.font='17px serif';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(SINS[i].sym,sx+31,row+25);
    } else {
      ctx.fillStyle='#3a1a1a';ctx.font='14px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText('ğŸ”’',sx+31,row+25);
    }

    if(!unl){
      ctx.fillStyle='#3a2020';ctx.font='10px Courier New';ctx.textAlign='left';ctx.textBaseline='alphabetic';
      ctx.fillText('ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Â«'+SINS[i-1]?.name+'Â» Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ',sx+56,row+28);
      continue;
    }

    ctx.fillStyle=gs.discovered[i]?SINS[i].glow:'#b09060';
    ctx.font='bold 12px Courier New';ctx.textAlign='left';ctx.textBaseline='alphabetic';
    ctx.fillText(SINS[i].name+'  ('+SINS[i].en+')',sx+56,row+20);
    ctx.fillStyle='#6a5a4a';ctx.font='9px Courier New';
    ctx.fillText('Ğ¡ĞµĞ¼Ñ: '+SINS[i].seedCost+'ğŸª™  Ğ£Ñ€Ğ¾Ğ¶Ğ°Ğ¹: '+SINS[i].sellPrice+'ğŸª™  Ğ Ğ¾ÑÑ‚: '+SINS[i].growTime+'Ñ',sx+56,row+34);
    if(gs.discovered[i]){ctx.fillStyle='#4a8a3a';ctx.fillText('âœ“ ĞĞ¢ĞšĞ Ğ«Ğ¢',sx+56,row+46);}
    else{ctx.fillStyle='#5a4a3a';ctx.fillText('Ğ½Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚',sx+56,row+46);}

    ctx.fillStyle='#c8a020';ctx.font='bold 14px Courier New';ctx.textAlign='right';ctx.textBaseline='middle';
    ctx.fillText('Ã—'+gs.seeds[i],sx+sw-20,row+25);

    if(sel){
      const canB=gs.coins>=SINS[i].seedCost;
      ctx.fillStyle=canB?'#c8a020':'#4a3a2a';ctx.font='9px Courier New';ctx.textAlign='right';ctx.textBaseline='alphabetic';
      ctx.fillText('[B] ĞºÑƒĞ¿Ğ¸Ñ‚ÑŒ: '+SINS[i].seedCost,sx+sw-70,row+47);
      ctx.fillStyle=gs.seeds[i]>0?'#c06040':'#3a2020';
      ctx.fillText('[V]',sx+sw-10,row+47);
    }
  }
  ctx.textBaseline='alphabetic';
}

function drawNotification(){
  if(!gs.notify)return;
  const d=gs.notify,sin=SINS[d.sinId];
  const elapsed=Date.now()-d.start;
  const alpha=elapsed<400?elapsed/400:elapsed>3500?1-(elapsed-3500)/500:1;
  ctx.save();ctx.globalAlpha=alpha;

  ctx.fillStyle='rgba(0,0,0,0.9)';ctx.fillRect(W/2-220,H/2-90,440,180);
  ctx.strokeStyle=sin.color;ctx.lineWidth=2;ctx.strokeRect(W/2-220,H/2-90,440,180);
  ctx.strokeStyle=sin.dark;ctx.lineWidth=1;ctx.strokeRect(W/2-216,H/2-86,432,172);

  ctx.fillStyle='#5a4a3a';ctx.font='11px Courier New';ctx.textAlign='center';ctx.textBaseline='alphabetic';
  ctx.fillText('â—†â—†â—†  ĞĞ‘ĞĞĞ Ğ£Ğ–Ğ•Ğ ĞĞĞ’Ğ«Ğ™ Ğ“Ğ Ğ•Ğ¥  â—†â—†â—†',W/2,H/2-58);

  ctx.shadowColor=sin.glow;ctx.shadowBlur=25;
  ctx.fillStyle=sin.color;ctx.font='bold 32px Courier New';
  ctx.fillText(sin.sym+'  '+sin.name,W/2,H/2-10);
  ctx.shadowBlur=0;

  ctx.fillStyle='#7a6a5a';ctx.font='14px Courier New';
  ctx.fillText('"'+sin.en+'"',W/2,H/2+20);

  ctx.fillStyle='#4a3a2a';ctx.font='10px Courier New';
  ctx.fillText('Ğ¡ĞµĞ¼ĞµĞ½Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ² Ğ»Ğ°Ğ²ĞºĞµ Ğ³Ñ€ĞµÑ…Ğ¾Ğ²',W/2,H/2+50);

  ctx.restore();
}

function drawDead(){
  ctx.fillStyle='rgba(0,0,0,0.8)';ctx.fillRect(0,0,W,H);
  ctx.shadowColor='#cc0000';ctx.shadowBlur=40;
  ctx.fillStyle='#8B0000';ctx.font='bold 52px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('Ğ¢Ğ« ĞŸĞĞ›',W/2,H/2-40);
  ctx.shadowBlur=0;
  ctx.fillStyle='#4a2a2a';ctx.font='14px Courier New';
  ctx.fillText('Ğ¡Ñ‚Ñ€Ğ°Ğ¶Ğ¸ Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ´ĞµÑ‚ĞµĞ»Ğ¸ Ğ²Ğ·ÑĞ»Ğ¸ Ğ²ĞµÑ€Ñ…...',W/2,H/2+10);
  ctx.fillStyle='#2a1a1a';ctx.font='11px Courier New';
  ctx.fillText('ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾',W/2,H/2+50);
  ctx.textBaseline='alphabetic';
}

function drawWin(){
  ctx.fillStyle='rgba(0,0,0,0.92)';ctx.fillRect(0,0,W,H);
  ctx.shadowColor='#9030e0';ctx.shadowBlur=50;
  ctx.fillStyle='#5a0a90';ctx.font='bold 48px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('Ğ’Ğ¡Ğ• 7 Ğ“Ğ Ğ•Ğ¥ĞĞ’',W/2,H/2-80);
  ctx.shadowBlur=10;ctx.fillStyle='#c8a020';ctx.font='bold 22px Courier New';
  ctx.fillText('ĞŸĞĞ—ĞĞĞĞ«',W/2,H/2-40);
  ctx.shadowBlur=0;
  ctx.fillStyle='#5a4a5a';ctx.font='13px Courier New';
  ctx.fillText('Ğ¢Ñ‹ Ğ·Ğ°Ğ³Ğ»ÑĞ½ÑƒĞ» Ğ² ÑĞ°Ğ¼ÑƒÑ Ñ‚ÑŒĞ¼Ñƒ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµÑ‡ĞµÑĞºĞ¾Ğ¹ Ğ´ÑƒÑˆĞ¸...',W/2,H/2);
  ctx.fillStyle='#c8a020';ctx.font='12px Courier New';
  ctx.fillText('ĞœĞ¾Ğ½ĞµÑ‚Ñ‹ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ¾: '+gs.coins,W/2,H/2+30);
  SINS.forEach((s,i)=>{
    ctx.shadowColor=s.glow;ctx.shadowBlur=10;
    ctx.font='26px serif';ctx.fillText(s.sym,W/2-90+i*30,H/2+80);
  });
  ctx.shadowBlur=0;ctx.textBaseline='alphabetic';
}

// â”€â”€â”€ MAIN LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let last=0;
function loop(ts){
  const dt=Math.min(ts-last,100);last=ts;
  gs.t+=dt;

  if(!gs.player.dead&&!gs.win&&!gs.shop.open){
    updatePlayer(dt);updatePlots();updateEnemies(dt);updateSpawn(dt);
  }

  ctx.fillStyle='#070503';ctx.fillRect(0,0,W,H);
  drawMap();drawPlots();
  for(const e of gs.enemies)drawEnemy(e);
  drawPlayer();
  drawRain();
  drawHUD();
  if(gs.shop.open)drawShop();
  if(gs.notify)drawNotification();
  if(gs.player.dead)drawDead();
  if(gs.win)drawWin();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
